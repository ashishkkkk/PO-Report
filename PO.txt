package com.example.automation;

import com.monitorjbl.xlsx.StreamingReader;
import org.apache.poi.ss.usermodel.Cell;
import java.awt.Toolkit;
import java.awt.datatransfer.Clipboard;
import java.awt.datatransfer.StringSelection;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.streaming.SXSSFWorkbook;
import org.yaml.snakeyaml.Yaml;
import picocli.CommandLine;
import picocli.CommandLine.Command;
import picocli.CommandLine.Option;

import javax.swing.JFileChooser;
import javax.swing.filechooser.FileNameExtensionFilter;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;

import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Scanner;

@Command(name = "run-automation", mixinStandardHelpOptions = true, version = "0.1")
public class Main implements Runnable {

    @Option(names = {"-c", "--config"}, description = "Path to YAML config", required = false)
    private Path config;

    // Column Indexes (0-based)
    private static final int COL_DMSPONO = 6; // Column G
    private static final int COL_SALORD_NO = 13; // Column N

    public static void main(String[] args) {
        int exitCode = new CommandLine(new Main()).execute(args);
        System.exit(exitCode);
    }

    @Override
    public void run() {
        try {
            String inputPathStr = "D:\\Certificate\\New Microsoft Excel Worksheet (2).xlsx";
            String outputPathStr = "output.xlsx";
            String sapConnectionName = "PRE Load Balance";

            if (config != null) {
                if (!Files.exists(config)) throw new IllegalArgumentException("config file not found: " + config);
                Yaml yaml = new Yaml();
                try (InputStream in = Files.newInputStream(config)) {
                    Map<String, Object> cfg = yaml.load(in);
                    inputPathStr = cfg != null && cfg.get("input") != null ? cfg.get("input").toString() : null;
                    outputPathStr = cfg != null && cfg.get("output") != null ? cfg.get("output").toString() : "output.xlsx";
                    if (cfg != null && cfg.get("sap_connection") != null) sapConnectionName = cfg.get("sap_connection").toString();
                }
            }

            if (inputPathStr == null) {
                System.out.println("No input file specified. Please select the raw data file.");
                inputPathStr = promptForFile();
            }

            if (inputPathStr == null || inputPathStr.isEmpty()) {
                System.err.println("No input file selected. Exiting.");
                System.exit(1);
            }

            process(Paths.get(inputPathStr), Paths.get(outputPathStr), sapConnectionName);
            System.out.println("Automation completed successfully");
        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
            e.printStackTrace();
            System.exit(1);
        }
    }

    private String promptForFile() {
        if (!java.awt.GraphicsEnvironment.isHeadless()) {
            JFileChooser fileChooser = new JFileChooser();
            fileChooser.setDialogTitle("Select Raw Data Excel File");
            fileChooser.setFileFilter(new FileNameExtensionFilter("Excel Files", "xlsx", "xls"));
            fileChooser.setCurrentDirectory(new java.io.File("."));
            int result = fileChooser.showOpenDialog(null);
            if (result == JFileChooser.APPROVE_OPTION) {
                return fileChooser.getSelectedFile().getAbsolutePath();
            }
        }

        System.out.println("Enter the full path to the raw data Excel file:");
        Scanner scanner = new Scanner(System.in);
        if (scanner.hasNextLine()) {
            String path = scanner.nextLine().trim();
            return path.replace("\"", "");
        }
        return null;
    }

    public void process(Path inputPath, Path outputPath, String sapConnectionName) throws Exception {
        System.out.println("Starting PO Report Processing...");
        System.out.println("Reading from: " + inputPath);

        Map<String, String[]> allUniqueRecordsMap = new LinkedHashMap<>();
        List<String> headers = new ArrayList<>();
        int totalRowsRead = 0;

        // 1. Read and Split Data
        try (InputStream is = new FileInputStream(inputPath.toFile());
             Workbook workbook = StreamingReader.builder()
                     .rowCacheSize(100)
                     .bufferSize(4096)
                     .open(is)) {

            Sheet sheet = workbook.getSheetAt(0);
            for (Row row : sheet) {
                int lastCellNum = row.getLastCellNum();
                String[] rowData = new String[Math.max(lastCellNum, COL_SALORD_NO + 2)];

                for (int i = 0; i < lastCellNum; i++) {
                    Cell cell = row.getCell(i);
                    rowData[i] = (cell != null) ? cell.getStringCellValue() : "";
                }

                if (row.getRowNum() == 0) {
                    for (String h : rowData) {
                        if (h != null) headers.add(h);
                    }
                    continue;
                }

                totalRowsRead++;
                String sdn = (rowData.length > COL_SALORD_NO) ? rowData[COL_SALORD_NO] : "";
                String poNumber = (rowData.length > COL_DMSPONO) ? rowData[COL_DMSPONO] : "";

                if (poNumber != null && !poNumber.isEmpty()) {
                    // Smart Deduplication: Prefer records that have an SDN
                    if (allUniqueRecordsMap.containsKey(poNumber)) {
                        String[] existing = allUniqueRecordsMap.get(poNumber);
                        String existingSdn = (existing.length > COL_SALORD_NO) ? existing[COL_SALORD_NO] : "";
                        
                        boolean existingHasSdn = existingSdn != null && !existingSdn.trim().isEmpty(); // Any text/number is valid
                        boolean newHasSdn = sdn != null && !sdn.trim().isEmpty(); // Any text/number is valid

                        // If existing entry has NO SDN, but the new one DOES, replace it.
                        if (!existingHasSdn && newHasSdn) {
                            allUniqueRecordsMap.put(poNumber, rowData);
                        }
                    } else {
                        allUniqueRecordsMap.put(poNumber, rowData);
                    }
                }
            }
        }

        // Separate into lists based on SDN presence
        List<String[]> recordsWithSdn = new ArrayList<>();
        Map<String, String[]> recordsWithoutSdnMap = new LinkedHashMap<>();

        for (Map.Entry<String, String[]> entry : allUniqueRecordsMap.entrySet()) {
            String[] rowData = entry.getValue();
            String sdn = (rowData.length > COL_SALORD_NO) ? rowData[COL_SALORD_NO] : "";
            
            if (sdn != null && !sdn.trim().isEmpty()) { // Consider ANY non-blank text as SDN
                recordsWithSdn.add(rowData);
            } else {
                recordsWithoutSdnMap.put(entry.getKey(), rowData);
            }
        }

        System.out.println("Read Complete.");
        System.out.println("Total Rows Read: " + totalRowsRead);
        System.out.println("Total Unique Records (after removing duplicates): " + allUniqueRecordsMap.size());
        System.out.println("Records with SDN: " + recordsWithSdn.size());
        System.out.println("Unique Records without SDN: " + recordsWithoutSdnMap.size());

        // 2. Process SAP Checks
        SapService sapService = new SapService();
        List<String> posToCheck = new ArrayList<>(recordsWithoutSdnMap.keySet());
        Map<String, Map<String, String>> sapResults = new LinkedHashMap<>();

        if (!posToCheck.isEmpty()) {
            sapResults = sapService.runSapAutomation(posToCheck, sapConnectionName);
        }

        List<String[]> processedWithoutSdn = new ArrayList<>();
        
        // Add Remark header
        headers.add("Remark");
        headers.add("Final Remark");

        // Update recordsWithSdn to include new columns and set "Interfaced"
        List<String[]> updatedRecordsWithSdn = new ArrayList<>();
        for (String[] rowData : recordsWithSdn) {
            if (rowData.length < headers.size()) {
                String[] newRowData = new String[headers.size()];
                System.arraycopy(rowData, 0, newRowData, 0, rowData.length);
                rowData = newRowData;
            }
            // Set Final Remark (last column)
            rowData[headers.size() - 1] = "Interfaced";
            updatedRecordsWithSdn.add(rowData);
        }
        recordsWithSdn = updatedRecordsWithSdn;

        for (Map.Entry<String, String[]> entry : recordsWithoutSdnMap.entrySet()) {
            String po = entry.getKey();
            String[] rowData = entry.getValue();

            // Resize rowData to fit Remark and Final Remark columns if needed
            if (rowData.length < headers.size()) {
                String[] newRowData = new String[headers.size()];
                System.arraycopy(rowData, 0, newRowData, 0, rowData.length);
                rowData = newRowData;
            }

            Map<String, String> sapResult = sapResults.get(po);
            String remark;

            if (sapResult != null) {
                String sapSdn = sapResult.get("SDN");
                String sapMsg = sapResult.get("MESSAGE");

                if (sapSdn != null && !sapSdn.trim().isEmpty()) {
                    rowData[COL_SALORD_NO] = sapSdn;
                    remark = "Added from SAP";
                } else {
                    remark = sapMsg != null ? sapMsg : "No SDN found in SAP";
                }
            } else {
                remark = "File Not Trigger from SAP";
            }

            // Set Remark (second to last column)
            rowData[headers.size() - 2] = remark;

            // Set Final Remark (last column)
            String finalRemark = "";
            if (remark != null && remark.toLowerCase().contains("credit")) {
                finalRemark = "Credit Balance issue";
            } else if (rowData[COL_SALORD_NO] != null && !rowData[COL_SALORD_NO].trim().isEmpty()) {
                finalRemark = "Interfaced";
            } else {
                finalRemark = remark; // Copy other remarks (like errors) to final remark
            }
            rowData[headers.size() - 1] = finalRemark;
            
            processedWithoutSdn.add(rowData);
        }

        // 3. Write Output
        try (SXSSFWorkbook outputWorkbook = new SXSSFWorkbook(100)) {
            Sheet outSheet = outputWorkbook.createSheet("Processed Data");

            int rowIndex = 0;

            Row headerRow = outSheet.createRow(rowIndex++);
            for (int i = 0; i < headers.size(); i++) {
                headerRow.createCell(i).setCellValue(headers.get(i));
            }

            for (String[] data : recordsWithSdn) {
                writeRow(outSheet.createRow(rowIndex++), data);
            }

            for (String[] data : processedWithoutSdn) {
                writeRow(outSheet.createRow(rowIndex++), data);
            }

            // 4. Create Summary Pivot Table
            System.out.println("Creating summary sheet...");

            // First, calculate the summary counts
            Map<String, Long> summaryCounts = new LinkedHashMap<>();
            int finalRemarkIndex = headers.size() - 1;

            for (String[] rowData : recordsWithSdn) {
                String finalRemark = (rowData.length > finalRemarkIndex && rowData[finalRemarkIndex] != null) ? rowData[finalRemarkIndex] : "Blank";
                summaryCounts.put(finalRemark, summaryCounts.getOrDefault(finalRemark, 0L) + 1);
            }

            for (String[] rowData : processedWithoutSdn) {
                String finalRemark = (rowData.length > finalRemarkIndex && rowData[finalRemarkIndex] != null) ? rowData[finalRemarkIndex] : "Blank";
                summaryCounts.put(finalRemark, summaryCounts.getOrDefault(finalRemark, 0L) + 1);
            }

            // Now, write the summary to a new sheet
            Sheet summarySheet = outputWorkbook.createSheet("Summary");
            int summaryRowIndex = 0;

            // Header for summary
            Row summaryHeaderRow = summarySheet.createRow(summaryRowIndex++);
            summaryHeaderRow.createCell(0).setCellValue("Final Remark");
            summaryHeaderRow.createCell(1).setCellValue("Count of POs");

            // Data for summary
            for (Map.Entry<String, Long> summaryEntry : summaryCounts.entrySet()) {
                Row summaryDataRow = summarySheet.createRow(summaryRowIndex++);
                summaryDataRow.createCell(0).setCellValue(summaryEntry.getKey());
                summaryDataRow.createCell(1).setCellValue(summaryEntry.getValue());
            }

            try {
                try (FileOutputStream fos = new FileOutputStream(outputPath.toFile())) {
                    outputWorkbook.write(fos);
                }
            } catch (java.io.FileNotFoundException e) {
                System.err.println("ERROR: Could not open output file '" + outputPath + "'. Please close it if it is open in Excel.");
                throw e;
            }
            outputWorkbook.dispose();
        }

        System.out.println("Processing Complete. Output saved to: " + outputPath);
    }

    private void writeRow(Row row, String[] data) {
        for (int i = 0; i < data.length; i++) {
            if (data[i] != null) {
                row.createCell(i).setCellValue(data[i]);
            }
        }
    }

    // --- Inner Classes ---

    public static class SapService {
        
        public Map<String, Map<String, String>> runSapAutomation(List<String> poNumbers, String connectionName) {
            System.out.println("Connecting to SAP using connection name: " + connectionName);
            Map<String, Map<String, String>> results = new LinkedHashMap<>();
            String user = "Bijus";
            String pass = "Royal@26";

            try {
                // 1. Copy POs to Clipboard for SAP Paste
                String clipboardData = String.join("\r\n", poNumbers);
                StringSelection selection = new StringSelection(clipboardData);
                Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();
                clipboard.setContents(selection, selection);
                System.out.println("Copied " + poNumbers.size() + " PO numbers to clipboard.");

                // Ensure SAP Logon is running
                Process checkSap = Runtime.getRuntime().exec("tasklist /FI \"IMAGENAME eq saplogon.exe\"");
                Scanner scanner = new Scanner(checkSap.getInputStream());
                if (!scanner.useDelimiter("\\A").next().contains("saplogon.exe")) {
                    System.out.println("Starting SAP Logon...");
                    Runtime.getRuntime().exec("C:\\Program Files\\SAP\\FrontEnd\\SAPGUI\\saplogon.exe");
                    Thread.sleep(5000); // Wait for SAP to open
                }
                scanner.close();

                // Prepare Temp File for Export
                String tempDir = System.getProperty("java.io.tmpdir");
                if (!tempDir.endsWith(File.separator)) tempDir += File.separator;
                String exportFileName = "sap_export.txt";
                File exportFile = new File(tempDir + exportFileName);
                if (exportFile.exists()) exportFile.delete();
                
                String debugLogFileName = "sap_debug_log.txt";
                File debugLogFile = new File(tempDir + debugLogFileName);
                if (debugLogFile.exists()) debugLogFile.delete();
                System.out.println("SAP Debug Log will be written to: " + debugLogFile.getAbsolutePath());

                StringBuilder vbsContent = new StringBuilder();
                // --- VBScript Generation ---
                vbsContent.append("If Not IsObject(application) Then\n");
                vbsContent.append("   Set SapGuiAuto  = GetObject(\"SAPGUI\")\n");
                vbsContent.append("   Set application = SapGuiAuto.GetScriptingEngine\n");
                vbsContent.append("End If\n");
                
                // Debug Logging setup
                vbsContent.append("Set fso = CreateObject(\"Scripting.FileSystemObject\")\n");
                vbsContent.append("Set debugLog = fso.CreateTextFile(\"").append(debugLogFile.getAbsolutePath().replace("\\", "\\\\")).append("\", True)\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] VBScript Started.\"\n");
                vbsContent.append("On Error Resume Next\n"); // Enable error handling for VBScript

                vbsContent.append("Set connection = application.OpenConnection(\"").append(connectionName).append("\", True)\n");
                vbsContent.append("If Err.Number <> 0 Then debugLog.WriteLine \"[\" & Now & \"] ERROR: Could not open connection: \" & Err.Description & \" (\" & Err.Number & \")\"\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] Connected to SAP: \" & (Not connection Is Nothing)\n");
                vbsContent.append("Set session = connection.Children(0)\n");
                // Maximize SAP window to ensure it is visible
                vbsContent.append("session.findById(\"wnd[0]\").maximize\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] SAP window maximized.\"\n");

                // Login logic
                vbsContent.append("session.findById(\"wnd[0]/usr/txtRSYST-BNAME\").text = \"").append(user).append("\"\n");
                vbsContent.append("session.findById(\"wnd[0]/usr/pwdRSYST-BCODE\").text = \"").append(pass).append("\"\n");
                vbsContent.append("session.findById(\"wnd[0]\").sendVKey 0\n");
                vbsContent.append("If Err.Number <> 0 Then debugLog.WriteLine \"[\" & Now & \"] ERROR: Login failed: \" & Err.Description & \" (\" & Err.Number & \")\"\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] Login attempt complete.\"\n");

                vbsContent.append("session.findById(\"wnd[0]/tbar[0]/okcd\").text = \"/nSE16\"\n");
                vbsContent.append("session.findById(\"wnd[0]\").sendVKey 0\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] Navigated to SE16.\"\n");
                vbsContent.append("session.findById(\"wnd[0]/usr/ctxtDATABROWSE-TABLENAME\").text = \"ZSD_CDS_PO_IF\"\n");
                vbsContent.append("session.findById(\"wnd[0]\").sendVKey 0\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] Entered table ZSD_CDS_PO_IF.\"\n");

                // Click 'Multiple Selection' button for the POR field
                vbsContent.append("session.findById(\"wnd[0]/usr/btn%_I4_%_APP_%-VALU_PUSH\").press\n");
                vbsContent.append("WScript.Sleep 2000\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] Clicked Multiple Selection button.\"\n");
                
                // Paste from Clipboard (Button ID 24 is standard for 'Upload from Clipboard')
                vbsContent.append("session.findById(\"wnd[1]/tbar[0]/btn[24]\").press\n");
                vbsContent.append("WScript.Sleep 8000\n"); // Increased wait for large data paste

                vbsContent.append("session.findById(\"wnd[1]/tbar[0]/btn[8]\").press\n"); // Copy/Execute selection
                vbsContent.append("WScript.Sleep 2000\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] Pasted POs from clipboard and executed selection.\"\n");
                
                // Execute Query
                vbsContent.append("session.findById(\"wnd[0]/tbar[1]/btn[8]\").press\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] Executed main query.\"\n");
                
                // --- New Grid Interaction Logic ---
                vbsContent.append("On Error Resume Next\n");
                
                // Wait for Grid Object to appear (handle screen transition delay)
                vbsContent.append("Dim grid\n");
                vbsContent.append("Set grid = Nothing\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] Starting wait for grid object (up to 60s).\"\n");
                vbsContent.append("For k = 1 To 60\n"); // Wait up to 60 seconds for result screen
                vbsContent.append("  Err.Clear\n");
                vbsContent.append("  Set grid = session.findById(\"wnd[0]/usr/cntlGRID1/shellcont/shell\")\n");
                vbsContent.append("  If Err.Number = 0 Then Exit For\n");
                vbsContent.append("  WScript.Sleep 1000\n");
                vbsContent.append("Next\n");
                vbsContent.append("If Not grid Is Nothing Then\n");
                vbsContent.append("  debugLog.WriteLine \"[\" & Now & \"] Grid object found.\"\n");
                vbsContent.append("Else\n");
                vbsContent.append("  debugLog.WriteLine \"[\" & Now & \"] ERROR: Grid object NOT found after 60s. Last error: \" & Err.Description & \" (\" & Err.Number & \")\"\n");
                vbsContent.append("End If\n");

                vbsContent.append("If Not grid Is Nothing Then\n");
                
                // Add a dynamic wait loop for the grid to be populated with data
                vbsContent.append("  debugLog.WriteLine \"[\" & Now & \"] Starting wait for grid data (up to 120s).\"\n");
                vbsContent.append("  For j = 1 to 120\n"); // Wait up to 120 seconds for data to load
                vbsContent.append("    If grid.RowCount > 0 Then Exit For\n");
                vbsContent.append("    WScript.Sleep 1000\n");
                vbsContent.append("  Next\n");
                vbsContent.append("  debugLog.WriteLine \"[\" & Now & \"] Grid data check complete. RowCount: \" & grid.RowCount & \".\"\n");

                // Only proceed if rows were actually found
                vbsContent.append("  If grid.RowCount > 0 Then\n");
                
                // Sort by Document (SDN) column descending
                vbsContent.append("    grid.setCurrentCell -1, \"SDN\"\n");
                vbsContent.append("    grid.selectColumn \"SDN\"\n");
                vbsContent.append("    session.findById(\"wnd[0]/tbar[1]/btn[40]\").press\n"); // Descending sort button
                vbsContent.append("    WScript.Sleep 2000\n");
                vbsContent.append("    debugLog.WriteLine \"[\" & Now & \"] Grid sorted by SDN descending.\"\n");
                
                // Re-acquire grid object after sort to ensure validity
                vbsContent.append("    Set grid = session.findById(\"wnd[0]/usr/cntlGRID1/shellcont/shell\")\n");

                // Write to file using FileSystemObject
                vbsContent.append("    Set fso = CreateObject(\"Scripting.FileSystemObject\")\n");
                vbsContent.append("    Set f = fso.CreateTextFile(\"").append(exportFile.getAbsolutePath().replace("\\", "\\\\")).append("\", True)\n");
                vbsContent.append("    rowCount = grid.RowCount\n");
                vbsContent.append("    debugLog.WriteLine \"[\" & Now & \"] Starting data extraction loop for \" & rowCount & \" rows.\"\n");
                vbsContent.append("    For i = 0 To rowCount - 1\n");
                vbsContent.append("      On Error Resume Next\n");
                // Ensure the row is selected/visible before reading (use setCurrentCell)
                // vbsContent.append("      grid.setCurrentCell i, \"DMSPONO\"\n");
                // vbsContent.append("      WScript.Sleep 300\n");
                vbsContent.append("      If i Mod 20 = 0 Then\n");
                vbsContent.append("        grid.firstVisibleRow = i\n");
                vbsContent.append("        WScript.Sleep 200\n");
                vbsContent.append("      End If\n");
                vbsContent.append("      por_val = \"\"\n");
                vbsContent.append("      sdn_val = \"\"\n");
                vbsContent.append("      msg_val = \"\"\n");
                vbsContent.append("      readAttempts = 0\n");
                vbsContent.append("      Do While readAttempts < 5\n");
                vbsContent.append("        On Error Resume Next\n");
                vbsContent.append("        por_val = grid.getCellValue(i, \"DMSPONO\")\n");
                vbsContent.append("        sdn_val = grid.getCellValue(i, \"SDN\")\n");
                vbsContent.append("        msg_val = grid.getCellValue(i, \"MESSAGE\")\n");
                vbsContent.append("        If Err.Number = 0 And Trim(por_val) <> \"\" Then Exit Do\n");
                vbsContent.append("        readAttempts = readAttempts + 1\n");
                vbsContent.append("        Err.Clear\n");
                vbsContent.append("        WScript.Sleep 200\n");
                vbsContent.append("      Loop\n");
                vbsContent.append("      If Err.Number = 0 Then\n");
                vbsContent.append("        f.WriteLine por_val & vbTab & sdn_val & vbTab & msg_val\n");
                vbsContent.append("      Else\n");
                vbsContent.append("        debugLog.WriteLine \"[\" & Now & \"] ERROR: Reading row \" & i & \": \" & Err.Description & \" (\" & Err.Number & \")\"\n");
                vbsContent.append("        Err.Clear\n");
                vbsContent.append("      End If\n");
                vbsContent.append("    Next\n");
                vbsContent.append("    f.Close\n");
                vbsContent.append("    debugLog.WriteLine \"[\" & Now & \"] Data extraction loop complete. Export file written.\"\n");
                vbsContent.append("  End If\n"); // End check for RowCount > 0
                vbsContent.append("End If\n");
                vbsContent.append("On Error GoTo 0\n");

                // Close SAP Window
                vbsContent.append("session.findById(\"wnd[0]/tbar[0]/okcd\").text = \"/nex\"\n");
                vbsContent.append("session.findById(\"wnd[0]\").sendVKey 0\n");
                vbsContent.append("debugLog.WriteLine \"[\" & Now & \"] VBScript Finished.\"\n");
                vbsContent.append("debugLog.Close\n"); // Close the debug log file

                Path scriptPath = Files.createTempFile("sap_script", ".vbs");
                Files.writeString(scriptPath, vbsContent.toString());
                Process p = Runtime.getRuntime().exec(new String[]{"wscript", scriptPath.toAbsolutePath().toString()});
                p.waitFor();

                // Wait for file to appear (polling)
                for (int i = 0; i < 15; i++) {
                    if (exportFile.exists() && exportFile.length() > 0) break;
                    Thread.sleep(1000);
                }

                // Read the exported file
                if (exportFile.exists()) {
                    try (BufferedReader br = new BufferedReader(new FileReader(exportFile))) {
                        String line;
                        
                        while ((line = br.readLine()) != null) {
                            // The new VBScript writes a simple "PO \t SDN \t MESSAGE" format.
                            String[] parts = line.split("\t", -1); // Use -1 to keep trailing empty parts
                            if (parts.length >= 1) {
                                String po = parts[0].trim();
                                if (po.isEmpty()) continue; // Skip lines that don't have a PO number

                                String newSdn = (parts.length > 1) ? parts[1].trim() : "";
                                String newMsg = (parts.length > 2) ? parts[2].trim() : "";

                                // If we haven't seen this PO before, add it to our results.
                                if (!results.containsKey(po)) {
                                    Map<String, String> data = new LinkedHashMap<>();
                                    data.put("SDN", newSdn);
                                    data.put("MESSAGE", newMsg);
                                    results.put(po, data);
                                } else {
                                    // An entry for this PO already exists. Check if we should update it.
                                    Map<String, String> existingData = results.get(po);
                                    String existingSdn = existingData.getOrDefault("SDN", "");

                                    // If the existing record has no SDN, but this new line does, update the record.
                                    if (existingSdn.isEmpty() && !newSdn.isEmpty()) {
                                        existingData.put("SDN", newSdn);
                                        existingData.put("MESSAGE", newMsg); // Also update the message
                                    }
                                }
                            }
                        }
                        System.out.println("SAP Extraction Complete. Found data for " + results.size() + " POs.");
                    }
                } else {
                    System.err.println("SAP Export file was not created. Check SAP execution.");
                }

            } catch (Exception e) {
                e.printStackTrace();
            }
            return results;
        }
    }
}
